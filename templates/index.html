{% extends 'base.html' %}

{% block content %}
<div class="container my-4">
    <!-- Dashboard Cards -->
    <div class="row">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Scans Completed</h5>
                    <p class="card-text">{{ data.scans_completed }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Alerts</h5>
                    <p class="card-text">{{ data.total_vulnerabilities }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row my-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Vulnerability Trends</h5>
                    <canvas id="areaChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Issues by Severity</h5>
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row my-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">OWASP TOP 10</h5>
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card" style="background-color: #1e1e1e;">
                <div class="card-body text-white text-center">
                    <h2 class="card-title text-white text-center">PROGRESO DEL ESCANER</h2>
                    <br>
                    <div id="ultimoScanner">...</div>
                <br>
                    <div class="d-flex justify-content-center">
                        <div style="width: 250px; height: 250px;">
                            <canvas id="scanProgressChart"></canvas>
                        </div>
                    </div>
                    <br>
                    <div class="text-center text-white mt-3">
                        <div><h4>Próximo Escaner</h4></div>
                        <div id="proximoScanner">...</div>
                        <div id="proximoScannerFecha">...</div>
                    </div>
                    <br>
                    <br>
                </div>
            </div>
        </div>
    </div>
    
    
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js"></script>
<script>
// Area Chart
const areaCtx = document.getElementById('areaChart').getContext('2d');
new Chart(areaCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Vulnerabilities Found',
            data: [100, 200, 150, 300, 250, 400],
            borderColor: 'rgba(0, 123, 255, 1)',
            backgroundColor: 'rgba(0, 123, 255, 0.2)',
        }]
    },
    options: {
        responsive: true,
    }
});

// Bar Chart
const barCtx = document.getElementById('barChart').getContext('2d');
new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: {{ data.chart_data.labels | tojson }},
        datasets: [{
            label: 'Issues by Severity',
            data: {{ data.chart_data.data | tojson }},
            backgroundColor: ['#007bff', '#ffc107', '#fd7e14', '#dc3545']
        }]
    },
    options: {
        responsive: true,
    }
});

const ctx = document.getElementById('radarChart').getContext('2d');

const radarChart = new Chart(ctx, {
  type: 'radar',
  data: {
    labels: {{ data.owasp_top_10.labels | tojson }},
    datasets: [{
      label: 'OWASP TOP 10',
      data: {{data.owasp_top_10.data | tojson}},
      fill: true,
      backgroundColor: 'rgba(54, 162, 235, 0.3)', 
      borderColor: 'rgba(54, 162, 235, 1)',
      borderWidth: 2, 
      pointBackgroundColor: 'rgba(54, 162, 235, 1)',
      pointBorderColor: '#fff',
      pointHoverBackgroundColor: '#fff',
      pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
    }]
  },
  options: {
    responsive: true,
    scales: {
      r: {
        angleLines: { color: "rgba(255, 255, 255, 0.3)" }, /* Líneas más visibles */
        grid: { color: "rgba(255, 255, 255, 0.2)" }, /* Mejor visibilidad */
        pointLabels: { color: "white", font: { size: 14 } }, /* Letras blancas */
        ticks: { color: "white", backdropColor: "transparent", font: { size: 12 } } /* Numeración blanca */
      }
    },
    plugins: {
      legend: {
        position: 'top',
        labels: { color: "white" } /* Leyenda blanca */
      },
      title: {
        display: true,
        text: 'Radar Chart - A01 a A10',
        color: "white"
      }
    }
  }
});

// Configuración del gráfico donut para el progreso
const progressCtx = document.getElementById('scanProgressChart').getContext('2d');
const progressChart = new Chart(progressCtx, {
    type: 'doughnut',
    data: {
        datasets: [{
            data: [0, 100],  // [progreso, restante]
            backgroundColor: ["#3aef37", "#333333"],  // [color progreso, color fondo]
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        radius: '100%',
        cutout: '85%',  // Tamaño del hueco en el centro
        plugins: {
            legend: {
                display: false  // Ocultar leyenda
            },
            tooltip: {
                enabled: false  // Desactivar tooltips
            }
        }
    },
    plugins: [{
        id: 'centerText',
        beforeDraw: function(chart) {
            const width = chart.width;
            const height = chart.height;
            const ctx = chart.ctx;
            
            ctx.restore();
            
            // Texto del porcentaje en el centro
            const fontSize = (height / 114).toFixed(2);
            ctx.font = fontSize + "em sans-serif";
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.fillStyle = "#9b9b9b"; //textto
            
            const text = chart.data.datasets[0].data[0] + "%";
            ctx.fillText(text, width / 2, height / 2);
            
            ctx.save();
        }
    }]
});

// Función para actualizar el gráfico de progreso
function actualizarProgreso() {
    $.ajax({
        url: '/scan_progress',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            // Actualizar datos del gráfico
            progressChart.data.datasets[0].data = [data.progress, 100 - data.progress];
            progressChart.update();
            
            document.getElementById('ultimoScanner').innerText = data.ultimoScanner;
                document.getElementById('proximoScanner').innerText = data.proximo;
            document.getElementById('proximoScannerFecha').innerText = data.fecha;
           
            // Si no ha terminado, seguir consultando
            if (data.progress < 100) {
                setTimeout(actualizarProgreso, 2000);  // Consultar cada 2 segundos
            }
        },
        error: function(error) {
            console.error("Error al obtener el progreso:", error);
            setTimeout(actualizarProgreso, 5000);  // Reintentar en 5 segundos
        }
    });
}

// Iniciar la actualización al cargar la página
$(document).ready(function() {
    actualizarProgreso();
});
</script>
{% endblock %}
